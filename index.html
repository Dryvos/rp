<html>
<head>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
  $(document).ready(function(){

    var db = window.localStorage;


    var cenario = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
       
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], 
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        
        
    ];


    for (let linha = 0; linha < cenario.length; linha++) {
        for (let coluna = 0; coluna < cenario[linha].length; coluna++) {
            if(cenario[linha][coluna] == 0){
                if(linha == 11 && coluna == 11){
                    $('#cenario').append('<img src="img/chao.png" data-linha="'+linha+'" data-coluna="'+coluna+'" class="cenario_chao_element posicionaPersonagem"/>');
                }else{
                    $('#cenario').append('<img src="img/chao.png" data-linha="'+linha+'" data-coluna="'+coluna+'" class="cenario_chao_element"/>');
                }
            }
            if(cenario[linha][coluna] == 1){
                $('#cenario').append('<img src="img/pedra.png" data-linha="'+linha+'" data-coluna="'+coluna+'" class="cenario_chao_element"/>');
            }
            
        }
        $('#cenario').append('<br/>');
    }


    var personagem = {
        Outfit: {
            Head  : '',
            Armor : '',
            Legs  : '',
            Boots : '',
            Shield: '',
            Arm   : ''
        },
        Life: 100,
        Mana: 100,
        Position: {
            Y:$('.posicionaPersonagem').attr('data-coluna'),
            X:$('.posicionaPersonagem').attr('data-linha')
        }
    }
    db.setItem('rpPersonagem',JSON.stringify(personagem));


    $('#personagem').css({
        top : $('.posicionaPersonagem').offset().top,
        left: $('.posicionaPersonagem').offset().left,
    });

    function posicionaPersonagem(linha,coluna){
        
        console.log('linha -> '+linha);
        console.log('coluna -> '+coluna);

        var top  = '';
        var left = '';
        var np = {
            Y : 0,
            X : 0
        }

        $('.cenario_chao_element').each(function (index, element) {
            var l = $(this).attr('data-linha');
            var c = $(this).attr('data-coluna');
            np.Y = l;
            np.X = c;
            if(l == linha && c == coluna){
                $('#personagem').css({
                    top : $(this).position().top,
                    left: $(this).position().left,
                });
                return false;
            }
        });

        var personagem = JSON.parse(db.getItem('rpPersonagem'));
        personagem.Position = {
            Y : np.Y,
            X : np.X
        };
        db.setItem('rpPersonagem',JSON.stringify(personagem));         
        return np;
    }

    function andarPersonagem(key,action){
        if(action == 'up'){
            setTimeout(() => {
                $("#personagem").html("<img src='img/mariofrontz.png' />");    
            }, 200);
            $('#personagem').clearQueue();
        }

        var personagem = JSON.parse(db.getItem('rpPersonagem'));

        console.log(personagem.Position);
        var pos = personagem.Position;

        console.log(cenario[parseInt(pos.Y)][parseInt(pos.X)]);
        console.log(key);
        if(key == 37){
            if(cenario[parseInt(pos.X)][parseInt(pos.Y)-1] == 0){
                var andar   = posicionaPersonagem(parseInt(pos.X)-1,parseInt(pos.Y)); // Esquerda
                var picture = 'img/left.gif';
                return false;
            }
        }else if(key == 38){
            if(cenario[parseInt(pos.X)-1][parseInt(pos.Y)] == 0){
                var andar   = posicionaPersonagem(parseInt(pos.X),parseInt(pos.Y)-1); // Cima
                var picture = 'img/back.gif';
                return false;
            }
        }else if(key == 39){
            if(cenario[parseInt(pos.X)][parseInt(pos.Y)+1] == 0){
                var andar   = posicionaPersonagem(parseInt(pos.X)+1,parseInt(pos.Y)); // Direita
                var picture = 'img/right.gif';
                return false;
            }
        }else if(key == 40){
            if(cenario[parseInt(pos.X)+1][parseInt(pos.Y)] == 0){
                var andar   = posicionaPersonagem(parseInt(pos.X),parseInt(pos.Y)+1); // Baixo
                var picture = 'img/front.gif';
                return false;
            }
        }

        $("#personagem").animate(andar,100);//esquerda
        $("#personagem").html("<img src='"+picture+"' />");
    }

    

    $(document).keyup(function(event) {
        event.preventDefault();
        event.stopPropagation();

        if(event.which == 37 || event.which == 38 || event.which == 39 || event.which == 40){
            andarPersonagem(event.which,'up');
            return false;
        }
        
    }).keydown(function(event) {
        event.preventDefault();
        event.stopPropagation();
        if(event.which == 37 || event.which == 38 || event.which == 39 || event.which == 40){
            andarPersonagem(event.which,'sown');
            return false;
        }
    });


    



    //implementando a parte dos monstros
    function monstros(){
        localDB.transaction(function (tx) {
            tx.executeSql('SELECT * FROM monstros', [], function (tx, results) {
                var len = results.rows.length, i;
                for (i = 0; i < len; i++){
                    var row = results.rows.item(i);
                    $("#monstros").after("<div id='monstro_"+row['CodMonstro']+"' class='monstro'><img src='img/monstros/"+row['ImagemMonstro']+"'/></div>");
                    setTimeout(function(){
                        //alert(Math.random(0,100));
                        $("#monstro_"+row['CodMonstro']).animate();
                    },1000);
                }
            });
        });
    }

    //monstros();


  });
</script>
<style>
    html,body{
        padding:0px;
        margin:0px;
        overflow:hidden;
    }
    .prePersonagem{ height:0px; width:0px; overflow:hidden; }
    #personagem{ position: fixed; width: 50px; z-index:2; }
    #controles{ background: #DDD; height: 100px; width: 100px; font-size: 20px; position: fixed; top: 70%; left: 68%; }
    #controles #cima{ border: solid 1px; height: 30px; width: 30px; position: relative; left: 33%; }
    #controles #direita{ border: solid 1px; height: 30px; width: 30px; float: right; position:relative; top:-1%; left:-2%; }
    #controles #baixo{  border: solid 1px; height: 30px; width: 30px; position: relative; left: 33%; top: 30%; }
    #controles #esquerda{ border: solid 1px; height: 30px; width: 30px; position: relative; top: -33%; }
    .monstro{position:relative; border:solid 1px; height: 50px; width:50px;}
    .cenario_chao_element{
        height:40px;
        width:60px;
        border:solid 1px red;
    }
</style>
</head>
<body>

<div class="prePersonagem">
    <img src="img/back.gif"/>
    <img src="img/front.gif"/>
    <img src="img/left.gif"/>
    <img src="img/right.gif"/>
    <img src="img/mariofrontz.png"/>
    <img src="img/marioleft.png"/>
    <img src="img/marioright.png"/>
    <img src="img/marioback.png"/>
</div>

<div id="cenario"></div>








<div id="positions"></div>

<div id="personagem">
  <img src="img/mariofrontz.png" />
</div>

<div id="monstros"></div>

<div id="controles">
  <div id="cima">    ^</div>
  <div id="direita"> ></div>
  <div id="baixo">   V</div>
  <div id="esquerda"><</div>
</div>
</body>
</html>
